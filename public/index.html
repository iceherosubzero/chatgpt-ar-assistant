<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AR ChatGPT Assistant</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-ar@1.8.0/dist/aframe-ar.min.js"></script>
    <style>
      body, html { margin: 0; overflow: hidden; }
      #ui {
        position: fixed;
        bottom: 10px;
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 8px;
      }
      #prompt {
        width: 70%;
        padding: 8px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 16px;
      }
      #send, #talk {
        padding: 8px 16px;
        border-radius: 10px;
        border: none;
        background-color: #0084ff;
        color: white;
        font-size: 16px;
        cursor: pointer;
      }
      #talk.listening {
        background-color: #ff5555;
      }
    </style>
  </head>
  <body>
    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
      renderer="antialias: true;"
    >
      <a-entity id="assistant" position="0 0 -2">
        <a-sphere
          id="orb"
          color="#00ccff"
          radius="0.25"
          material="emissive: #00ccff; emissiveIntensity: 0.5;"
          animation__rotate="property: rotation; to: 0 360 0; loop: true; dur: 4000"
        ></a-sphere>
        <a-text id="reply" value="üëã Hi, I‚Äôm your AR companion!" position="-1 0.5 0" width="3" color="#ffffff"></a-text>
      </a-entity>
      <a-camera position="0 0 0"></a-camera>
    </a-scene>

    <div id="ui">
      <input type="text" id="prompt" placeholder="Say or type something..." />
      <button id="talk">üé§</button>
      <button id="send">Send</button>
    </div>

    <script>
      const orb = document.getElementById("orb");
      const replyText = document.getElementById("reply");
      const talkBtn = document.getElementById("talk");
      const sendBtn = document.getElementById("send");
      const promptInput = document.getElementById("prompt");

      // Text-to-speech
      function speak(text) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1;
        utter.pitch = 1;
        utter.lang = "en-US";
        speechSynthesis.speak(utter);
      }

      // Emotion-based color
      function updateOrbEmotion(text) {
        const lower = text.toLowerCase();
        let color = "#00ccff";
        let glow = "#00ccff";

        if (lower.includes("happy") || lower.includes("good") || lower.includes("great"))
          [color, glow] = ["#00ff99", "#66ffcc"];
        else if (lower.includes("sad") || lower.includes("sorry"))
          [color, glow] = ["#3366ff", "#6699ff"];
        else if (lower.includes("angry") || lower.includes("mad"))
          [color, glow] = ["#ff3333", "#ff6666"];
        else if (lower.includes("curious") || lower.includes("?"))
          [color, glow] = ["#ffcc00", "#ffee66"];
        else if (lower.includes("calm") || lower.includes("peace"))
          [color, glow] = ["#00cccc", "#33ffff"];

        orb.setAttribute("color", color);
        orb.setAttribute("material", `emissive: ${glow}; emissiveIntensity: 0.8;`);
        orb.setAttribute("animation__pulse", "property: scale; to: 1.3 1.3 1.3; dir: alternate; dur: 1000; loop: true;");
      }

      // Secure backend call
      async function askChatGPT(prompt) {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
        });
        const data = await response.json();
        return data.choices[0].message.content;
      }

      async function handlePrompt(prompt) {
        if (!prompt) return;
        replyText.setAttribute("value", "ü§î Thinking...");
        const answer = await askChatGPT(prompt);
        replyText.setAttribute("value", answer);
        speak(answer);
        updateOrbEmotion(answer);
      }

      sendBtn.onclick = () => {
        const userPrompt = promptInput.value.trim();
        promptInput.value = "";
        handlePrompt(userPrompt);
      };

      // Speech Recognition
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = SpeechRecognition ? new SpeechRecognition() : null;

      if (recognition) {
        recognition.lang = "en-US";
        recognition.onstart = () => {
          talkBtn.classList.add("listening");
          talkBtn.textContent = "üéôÔ∏è Listening...";
        };
        recognition.onend = () => {
          talkBtn.classList.remove("listening");
          talkBtn.textContent = "üé§";
        };
        recognition.onresult = (e) => {
          const text = e.results[0][0].transcript;
          promptInput.value = text;
          handlePrompt(text);
        };
        talkBtn.onclick = () => recognition.start();
      } else {
        talkBtn.disabled = true;
        talkBtn.textContent = "‚ùå No mic support";
      }
    </script>
  </body>
</html>
